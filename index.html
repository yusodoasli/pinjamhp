<!DOCTYPE html>
<html>
<head>
    <title>Log & Status HP Sekolah (Mobile Online)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <style>
        /* Pengaturan Dasar dan Font */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0;
            background-color: #f4f4f9;
        }

        /* Container Utama */
        .container {
            padding: 10px;
        }

        /* Judul */
        h2, h3 { 
            color: #333; 
            margin-top: 15px; 
            margin-bottom: 10px;
        }

        /* Input, Select, Button (Ukuran Mobile) */
        input[type="text"], input[type="number"], select, button { 
            padding: 12px; /* Lebih besar */
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 8px; /* Lebih halus */
            font-size: 16px;
        }
        
        button {
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            color: white; /* Warna teks putih untuk semua tombol */
        }
        button:active {
            opacity: 0.8;
        }

        /* Warna Tombol */
        .btn-pagi { background-color: #f44336; border: none; } 
        .btn-pinjam { background-color: #4CAF50; border: none; }
        .btn-kembali { background-color: #008CBA; border: none; }
        .btn-export { background-color: #ff9800; border: none; }
        .btn-reset { background-color: #d32f2f; border: none; }

        /* Form Section */
        .form-section { 
            background-color: white; 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .form-section h3 {
             border-bottom: 2px solid #eee; 
             padding-bottom: 8px;
        }

        /* --- Tabs Mobile View --- */
        .tab-buttons {
            display: flex;
            justify-content: space-around;
            background-color: #fff;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #ddd;
        }
        .tab-button {
            flex-grow: 1;
            padding: 15px 10px;
            border: none;
            background-color: #eee;
            color: #333;
            font-weight: 600;
            font-size: 15px;
            border-radius: 0;
        }
        .tab-button.active {
            background-color: #008CBA;
            color: white;
        }
        .tab-content {
            padding: 15px 0;
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* --- Tabel Status dan Log (Scrollable) --- */
        .table-wrapper {
            overflow-x: auto; /* Memungkinkan scroll horizontal pada tabel */
            margin-bottom: 20px;
        }

        table { 
            width: 100%; 
            min-width: 600px; /* Minimal lebar tabel agar tidak terlalu sempit */
            border-collapse: collapse; 
            margin-top: 5px; 
            background-color: #fff;
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 10px; 
            text-align: left; 
            font-size: 12px; /* Ukuran font lebih kecil agar kolom muat */
        }
        th { 
            background-color: #333; 
            color: white;
            position: sticky;
            top: 0;
        }
        
        #status_inventaris th { background-color: #555; }
        #status_body td:nth-child(3) { font-weight: bold; } /* HP Keluar */
    </style>
</head>
<body>

    <div class="container">
        <h2>üìù Log HP Sekolah</h2>
    </div>

    <div class="tab-buttons">
        <button class="tab-button active" onclick="showTab('input', this)">Input Data</button>
        <button class="tab-button" onclick="showTab('status', this)">Status Inventaris</button>
        <button class="tab-button" onclick="showTab('log', this)">Riwayat Log</button>
    </div>

    <div class="container">
        <div id="input" class="tab-content active">
            
            <div class="form-section">
                <h3>1. PENGUMPULAN PAGI (HP Awal)</h3>
                <p style="font-size: 14px; margin-top: -10px; color: #777;">Mencatat **Jumlah HP Awal** hari untuk kelas.</p>
                <select id="pagi_kelas" required>
                    <option value="">Pilih Kelas...</option>
                    <option value="X FAR">X FAR</option>
                    <option value="X KP 1">X KP 1</option>
                    <option value="X KP 2">X KP 2</option>
                    <option value="X KP 3">X KP 3</option>
                    <option value="XI FAR 1">XI FAR 1</option>
                    <option value="XI FAR 2">XI FAR 2</option>
                    <option value="XI KP 1">XI KP 1</option>
                    <option value="XI KP 2">XI KP 2</option>
                    <option value="XI KP 3">XI KP 3</option>
                    <option value="XII FAR 1">XII FAR 1</option>
                    <option value="XII FAR 2">XII FAR 2</option>
                    <option value="XII KP 1">XII KP 1</option>
                    <option value="XII KP 2">XII KP 2</option>
                </select>
                <input type="number" id="pagi_jumlah" placeholder="Jumlah HP Dikumpulkan" required>
                <button class="btn-pagi" onclick="catatPengumpulanPagi()">Catat Pengumpulan Sekarang</button>
            </div>
            
            <div class="form-section">
                <h3>2. PINJAM (HP KELUAR)</h3>
                <input type="text" id="pinjam_pj" placeholder="Nama PJ/Peminjam" required>
                <select id="pinjam_kelas" required>
                    <option value="">Pilih Kelas...</option>
                    <option value="X FAR">X FAR</option>
                    <option value="X KP 1">X KP 1</option>
                    <option value="X KP 2">X KP 2</option>
                    <option value="X KP 3">X KP 3</option>
                    <option value="XI FAR 1">XI FAR 1</option>
                    <option value="XI FAR 2">XI FAR 2</option>
                    <option value="XI KP 1">XI KP 1</option>
                    <option value="XI KP 2">XI KP 2</option>
                    <option value="XI KP 3">XI KP 3</option>
                    <option value="XII FAR 1">XII FAR 1</option>
                    <option value="XII FAR 2">XII FAR 2</option>
                    <option value="XII KP 1">XII KP 1</option>
                    <option value="XII KP 2">XII KP 2</option>
                </select>
                <input type="number" id="pinjam_jumlah" placeholder="Jumlah HP Dipinjam" required>
                <input type="text" id="pinjam_guru" placeholder="Guru Mata Pelajaran" required>
                <button class="btn-pinjam" onclick="catatPeminjaman()">Catat Peminjaman Sekarang</button>
            </div>

            <div class="form-section">
                <h3>3. KEMBALI (HP MASUK)</h3>
                <input type="text" id="kembali_pj" placeholder="Nama PJ/Pengembali" required>
                <select id="kembali_kelas" required>
                    <option value="">Pilih Kelas...</option>
                    <option value="X FAR">X FAR</option>
                    <option value="X KP 1">X KP 1</option>
                    <option value="X KP 2">X KP 2</option>
                    <option value="X KP 3">X KP 3</option>
                    <option value="XI FAR 1">XI FAR 1</option>
                    <option value="XI FAR 2">XI FAR 2</option>
                    <option value="XI KP 1">XI KP 1</option>
                    <option value="XI KP 2">XI KP 2</option>
                    <option value="XI KP 3">XI KP 3</option>
                    <option value="XII FAR 1">XII FAR 1</option>
                    <option value="XII FAR 2">XII FAR 2</option>
                    <option value="XII KP 1">XII KP 1</option>
                    <option value="XII KP 2">XII KP 2</option>
                </select>
                <input type="number" id="kembali_jumlah" placeholder="Jumlah HP Dikembalikan" required>
                <button class="btn-kembali" onclick="catatPengembalian()">Catat Pengembalian Sekarang</button>
            </div>

            <div class="form-section" style="background-color: #fff8e1;">
                <h3>‚öôÔ∏è PENGATURAN & CADANGAN DATA</h3>
                <button class="btn-export" onclick="alert('Fungsi ini harus diperbarui untuk data online. Silakan eksport data dari Google Sheets secara langsung.')">EXPORT RIWAYAT LOG (.csv) - [NON-AKTIF]</button>
                <button class="btn-reset" onclick="alert('Fungsi reset total memerlukan kode Apps Script tambahan. Silakan hapus data langsung di Google Sheets.')">HAPUS SEMUA RIWAYAT LOG & STATUS - [NON-AKTIF]</button>
                <p style="font-size: 0.8em; color: #757575; text-align: center;">‚ö†Ô∏è **Peringatan:** Fitur Export dan Reset di non-aktifkan. Lakukan di Google Sheets Anda.</p>
            </div>
            
        </div>

        <div id="status" class="tab-content">
            <h3>üìä Status HP Terkini</h3>
            <div class="table-wrapper">
                <table id="status_inventaris">
                    <thead>
                        <tr>
                            <th>Kelas</th>
                            <th>HP Awal</th>
                            <th>HP Keluar</th>
                            <th>HP Sisa</th>
                            <th>Keterangan</th>
                        </tr>
                    </thead>
                    <tbody id="status_body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="log" class="tab-content">
            <h3>Riwayat Log (Aksi)</h3>
            <div class="table-wrapper">
                <table id="log_table">
                    <thead>
                        <tr>
                            <th>Aksi</th>
                            <th>Waktu</th>
                            <th>PJ/Peminjam</th>
                            <th>Kelas</th>
                            <th>Jml HP</th>
                            <th>Guru Mapel</th>
                        </tr>
                    </thead>
                    <tbody id="log_body">
                        </tbody>
                </table>
            </div>
        </div>
    </div> <script>
        // API URL ANDA - JANGAN DIUBAH!
        const API_URL = 'https://script.google.com/macros/s/AKfycbw3LZqrWY3lGo79uL0z4QhHAPjtt7lb9mWq1ps5YSJq3Ma5MuD2qSX0mmph_fo429k/exec'; 
        
        const DAFTAR_KELAS = [
            "X FAR", "X KP 1", "X KP 2", "X KP 3",
            "XI FAR 1", "XI FAR 2", "XI KP 1", "XI KP 2", "XI KP 3",
            "XII FAR 1", "XII FAR 2", "XII KP 1", "XII KP 2"
        ];

        // --- FUNGSI TABS ---
        function showTab(tabId, element) {
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));

            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            element.classList.add('active');
            
            // Pastikan data diperbarui saat berpindah ke tab Status/Log
            if (tabId === 'status') {
                perbaruiStatusInventaris();
            } else if (tabId === 'log') {
                tampilkanLog();
            }
        }
        
        // --- FUNGSI API BARU ---

        // Mengambil data dari Google Sheet (GET request)
        async function muatLog() {
            try {
                const response = await fetch(API_URL, { method: 'GET' });
                if (!response.ok) {
                    throw new Error('Gagal mengambil data dari server.');
                }
                const logData = await response.json();
                return logData;
            } catch (error) {
                console.error("Fetch Error:", error);
                alert("üö® Gagal memuat data log dari server. Cek koneksi atau URL API.");
                return []; 
            }
        }

        // Mengirim satu entri log baru ke Google Sheet (POST request)
        async function kirimLogBaru(newLogEntry) {
            try {
                if (!navigator.onLine) {
                    alert("‚ùå Anda sedang offline. Koneksi internet diperlukan untuk menyimpan data secara online.");
                    return false;
                }

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(newLogEntry),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Gagal menyimpan data ke server. Cek kembali Apps Script.');
                }
                
                // Setelah sukses menyimpan, kita perbarui status dan log di tampilan
                await perbaruiStatusInventaris(); 
                await tampilkanLog();
                return true;
                
            } catch (error) {
                console.error("Save Error:", error);
                alert("üö® Gagal menyimpan data ke server. Cek kembali URL API.");
                return false;
            }
        }

        // --- FUNGSI STATUS INVENTARIS ---
        async function perbaruiStatusInventaris() {
            const logData = await muatLog(); // Memuat data dari online
            const statusBody = document.getElementById('status_body');
            statusBody.innerHTML = '';
            
            const statusKelas = {}; 

            logData.forEach(item => {
                const kelas = item.kelas;
                if (!statusKelas[kelas]) {
                    statusKelas[kelas] = { awal: 0, keluar: 0, sisa: 0 };
                }
                // Pastikan item.jumlah adalah angka
                const jumlah = parseInt(item.jumlah);

                if (item.aksi === 'PENGUMPULAN PAGI') {
                    // Dalam implementasi ini, PENGUMPULAN PAGI yang baru akan menimpa data 'awal'
                    statusKelas[kelas].awal = jumlah;
                } else if (item.aksi === 'PINJAM (KELUAR)') {
                    statusKelas[kelas].keluar += jumlah;
                } else if (item.aksi === 'KEMBALI (MASUK)') {
                    statusKelas[kelas].keluar -= jumlah;
                }
            });

            DAFTAR_KELAS.forEach(kelas => {
                const status = statusKelas[kelas] || { awal: 0, keluar: 0, sisa: 0 };
                status.sisa = status.awal - status.keluar;

                const row = statusBody.insertRow();
                row.insertCell().textContent = kelas;
                row.insertCell().textContent = status.awal;
                
                const cellKeluar = row.insertCell();
                cellKeluar.textContent = status.keluar < 0 ? 'Error!' : status.keluar;
                cellKeluar.style.backgroundColor = status.keluar > 0 ? '#ffdddd' : '#ddffdd'; 

                const cellSisa = row.insertCell();
                cellSisa.textContent = status.sisa;
                cellSisa.style.fontWeight = 'bold';
                cellSisa.style.color = status.sisa < 0 ? 'red' : 'green';
                
                let keterangan = '';
                if (status.awal === 0) {
                    keterangan = 'Belum ada pengumpulan.';
                } else if (status.sisa < 0 || status.keluar < 0) {
                    keterangan = 'ERROR!';
                    row.style.backgroundColor = '#ffcdd2'; 
                } else if (status.keluar > 0) {
                    keterangan = 'Sedang Dipinjam.';
                } else {
                    keterangan = 'HP Lengkap.';
                }
                row.insertCell().textContent = keterangan;
            });
        }

        // --- FUNGSI RIWAYAT LOG ---
        async function tampilkanLog() {
            const logData = await muatLog(); // Memuat data dari online
            const logBody = document.getElementById('log_body');
            logBody.innerHTML = ''; 
            
            // Urutkan data dari yang terbaru ke terlama
            logData.sort((a, b) => new Date(b.waktu) - new Date(a.waktu));

            logData.forEach(item => {
                const row = logBody.insertRow();
                row.insertCell().textContent = item.aksi.replace('(KELUAR)', 'K').replace('(MASUK)', 'M').replace('PENGUMPULAN PAGI', 'PAGI'); // Singkat untuk mobile
                row.insertCell().textContent = new Date(item.waktu).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}); 
                row.insertCell().textContent = item.pj || '-'; // PJ bisa kosong
                row.insertCell().textContent = item.kelas;
                row.insertCell().textContent = item.jumlah;
                row.insertCell().textContent = item.guru || '-';
            });
        }

        // --- FUNGSI PENGUMPULAN PAGI (Online Save) ---
        async function catatPengumpulanPagi() { 
            const kelas = document.getElementById('pagi_kelas').value; 
            const jumlah = document.getElementById('pagi_jumlah').value;

            if (!kelas || !jumlah) {
                alert('Pilih Kelas dan isi Jumlah HP pada Pengumpulan Pagi!');
                return;
            }
            
            const newLogEntry = {
                aksi: 'PENGUMPULAN PAGI',
                pj: '-', 
                kelas: kelas,
                jumlah: jumlah,
                guru: '' 
            };

            const success = await kirimLogBaru(newLogEntry);

            if (success) {
                alert(`Pengumpulan HP Awal untuk kelas ${kelas} (${jumlah} unit) berhasil dicatat dan tersimpan online.`);
                document.getElementById('pagi_kelas').value = ''; 
                document.getElementById('pagi_jumlah').value = '';
            }
        }

        // --- FUNGSI PINJAM (Online Save + Validation) ---
        async function catatPeminjaman() {
            const pj = document.getElementById('pinjam_pj').value;
            const kelas = document.getElementById('pinjam_kelas').value;
            const jumlah = document.getElementById('pinjam_jumlah').value;
            const guru = document.getElementById('pinjam_guru').value;

            if (!pj || !kelas || !jumlah || !guru) {
                alert('Semua kolom Peminjaman harus diisi!');
                return;
            }
            
            // VALIDASI STOK (Mengambil data status dari Google Sheet)
            const logData = await muatLog(); 
            let statusKelas = { [kelas]: { awal: 0, keluar: 0 } }; 
            
            // Logika perhitungan status HP
            logData.forEach(item => {
                if (item.kelas === kelas) {
                    const jml = parseInt(item.jumlah);
                    if (item.aksi === 'PENGUMPULAN PAGI') { statusKelas[kelas].awal = jml; }
                    else if (item.aksi === 'PINJAM (KELUAR)') { statusKelas[kelas].keluar += jml; } 
                    else if (item.aksi === 'KEMBALI (MASUK)') { statusKelas[kelas].keluar -= jml; } 
                }
            });

            const sisaHP = (statusKelas[kelas].awal || 0) - (statusKelas[kelas].keluar || 0);
            
            if (sisaHP < parseInt(jumlah)) {
                alert(`HP kelas ${kelas} yang tersisa di piket hanya ${sisaHP}. Tidak cukup untuk meminjam ${jumlah} unit. Transaksi dibatalkan!`);
                return;
            }

            // Siapkan data untuk dikirim ke API
            const newLogEntry = { 
                aksi: 'PINJAM (KELUAR)',
                pj: pj,
                kelas: kelas,
                jumlah: jumlah,
                guru: guru
            };

            // KIRIM DATA ke Google Sheet
            const success = await kirimLogBaru(newLogEntry);
            
            if (success) {
                alert(`Peminjaman HP oleh ${pj} (${jumlah} unit) berhasil dicatat dan tersimpan online.`);
                document.getElementById('pinjam_pj').value = '';
                document.getElementById('pinjam_jumlah').value = '';
                document.getElementById('pinjam_guru').value = '';
            }
        }

        // --- FUNGSI PENGEMBALIAN (Online Save) ---
        async function catatPengembalian() {
            const pj = document.getElementById('kembali_pj').value;
            const kelas = document.getElementById('kembali_kelas').value;
            const jumlah = document.getElementById('kembali_jumlah').value;

            if (!pj || !kelas || !jumlah) {
                alert('Semua kolom Pengembalian harus diisi!');
                return;
            }

            // Siapkan data untuk dikirim ke API
            const newLogEntry = {
                aksi: 'KEMBALI (MASUK)',
                pj: pj,
                kelas: kelas,
                jumlah: jumlah,
                guru: '' 
            };

            // KIRIM DATA ke Google Sheet
            const success = await kirimLogBaru(newLogEntry);

            if (success) {
                alert(`Pengembalian HP oleh ${pj} (${jumlah} unit) berhasil dicatat dan tersimpan online.`);
                document.getElementById('kembali_pj').value = '';
                document.getElementById('kembali_jumlah').value = '';
            }
        }

        // Jalankan fungsi saat halaman dimuat
        window.onload = function() {
            // Memastikan tampilan status terisi saat halaman dibuka
            perbaruiStatusInventaris(); 
        };
    </script>

</body>
</html>
